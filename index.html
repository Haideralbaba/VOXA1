/**
 * Main chat application logic.
 * This script handles DOM manipulation, event listeners, and API calls for the chat application.
 * It's structured to be self-contained and runnable within a single HTML file.
 */

// Global variables for Firebase services and user data
let db;
let auth;
let userId;

// Get the necessary Firebase config and app ID from the environment.
// These variables are injected into the environment by the Canvas platform.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// DOM elements
const $chatButtonsContainer = document.getElementById('chat-buttons-container');
const $userList = document.getElementById('user-list');
const $chatHistory = document.getElementById('chat-history');
const $messageInput = document.getElementById('message-input');
const $sendButton = document.getElementById('send-button');
const $messageModal = document.getElementById('message-modal');
const $modalMessage = document.getElementById('modal-message');
const $modalCloseButton = document.getElementById('modal-close-button');
const $copyUserIdButton = document.getElementById('copy-user-id');
const $openChatButtons = document.querySelectorAll('.open-chat-btn');
const $chatContainer = document.getElementById('chat-container');
const $chatWithUserIdInput = document.getElementById('chat-with-user-id');
const $startChatBtn = document.getElementById('start-chat-btn');
const $backButton = document.getElementById('back-button');

// Current chat state
let currentChatId = null;
let currentChatName = 'Public';

// Initialize the Firebase application
function initializeFirebase() {
  try {
    const app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore(app);
    auth = firebase.auth(app);

    // Listen for authentication state changes
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        // User is signed in.
        userId = user.uid;
        console.log("User signed in with UID:", userId);
        document.getElementById('user-id-display').textContent = `معرف المستخدم الخاص بك: ${userId}`;
        document.getElementById('user-id-display').style.display = 'block';
        await loadUserList();
      } else {
        // User is signed out.
        console.log("User signed out. Signing in anonymously...");
        try {
          if (initialAuthToken) {
            await firebase.auth().signInWithCustomToken(auth, initialAuthToken);
          } else {
            await firebase.auth().signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Authentication failed:", error);
          showModal(`خطأ في المصادقة: ${error.message}`);
        }
      }
    });

  } catch (error) {
    console.error("Firebase initialization error:", error);
    showModal(`خطأ في تهيئة Firebase: ${error.message}`);
  }
}

/**
 * Displays a modal with a given message.
 * @param {string} message The message to display.
 */
function showModal(message) {
  $modalMessage.textContent = message;
  $messageModal.style.display = 'flex';
}

// Event listener for closing the modal
$modalCloseButton.addEventListener('click', () => {
  $messageModal.style.display = 'none';
});

// Event listener for copying the user ID
$copyUserIdButton.addEventListener('click', () => {
  if (userId) {
    // Use the old document.execCommand for better compatibility in iframes
    const textarea = document.createElement('textarea');
    textarea.value = userId;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      showModal('تم نسخ معرف المستخدم!');
    } catch (err) {
      console.error('Failed to copy text:', err);
      showModal('فشل في نسخ معرف المستخدم.');
    }
    document.body.removeChild(textarea);
  } else {
    showModal('لم يتم العثور على معرف المستخدم.');
  }
});

// Set up event listeners after the DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Check if Firebase is available
  if (typeof firebase === 'undefined') {
    console.error("Firebase is not loaded. Please check the script tag.");
    showModal("خطأ: لم يتم تحميل Firebase. الرجاء التحقق من اتصالك بالإنترنت.");
    return;
  }
  initializeFirebase();

  // Handle opening a chat
  if ($openChatButtons) {
    $openChatButtons.forEach(button => {
      button.addEventListener('click', () => {
        const chatType = button.getAttribute('data-chat-type');
        let chatName = 'Public Chat';
        let chatId = 'public';

        if (chatType === 'private') {
          chatName = 'Private Chat';
          chatId = userId;
        }

        switchChat(chatId, chatName);
      });
    });
  }

  // Handle starting a private chat with a specific user ID
  if ($startChatBtn) {
    $startChatBtn.addEventListener('click', async () => {
      const targetUserId = $chatWithUserIdInput.value.trim();
      if (targetUserId) {
        if (targetUserId === userId) {
          showModal('لا يمكنك الدردشة مع نفسك!');
          return;
        }
        const chatId = [userId, targetUserId].sort().join('_');
        switchChat(chatId, `الدردشة مع ${targetUserId}`);
        $chatWithUserIdInput.value = '';
      } else {
        showModal('الرجاء إدخال معرف مستخدم لبدء الدردشة.');
      }
    });
  }

  // Handle sending a message
  if ($sendButton) {
    $sendButton.addEventListener('click', sendMessage);
  }
  if ($messageInput) {
    $messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  }

  // Handle the back button
  if ($backButton) {
    $backButton.addEventListener('click', () => {
      switchChat('public', 'الدردشة العامة');
      $chatContainer.style.display = 'none';
      $chatButtonsContainer.style.display = 'flex';
      $userList.style.display = 'block';
    });
  }
});
