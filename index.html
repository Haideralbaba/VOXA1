/**
 * Main chat application logic.
 * This script handles DOM manipulation, event listeners, and API calls for the chat application.
 * It's structured to be self-contained and runnable within a single HTML file.
 */

// Global variables for Firebase services and user data
let db;
let auth;
let userId;

// Get the necessary Firebase config and app ID from the environment.
// These variables are injected into the environment by the Canvas platform.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// DOM elements
const $chatButtonsContainer = document.getElementById('chat-buttons-container');
const $userList = document.getElementById('user-list');
const $chatHistory = document.getElementById('chat-history');
const $messageInput = document.getElementById('message-input');
const $sendButton = document.getElementById('send-button');
const $messageModal = document.getElementById('message-modal');
const $modalMessage = document.getElementById('modal-message');
const $modalCloseButton = document.getElementById('modal-close-button');
const $copyUserIdButton = document.getElementById('copy-user-id');
const $openChatButtons = document.querySelectorAll('.open-chat-btn');
const $chatContainer = document.getElementById('chat-container');
const $chatWithUserIdInput = document.getElementById('chat-with-user-id');
const $startChatBtn = document.getElementById('start-chat-btn');
const $backButton = document.getElementById('back-button');

// Current chat state
let currentChatId = null;
let currentChatName = 'Public';

// Initialize the Firebase application
function initializeFirebase() {
  try {
    const app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore(app);
    auth = firebase.auth(app);

    // Listen for authentication state changes
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        // User is signed in.
        userId = user.uid;
        console.log("User signed in with UID:", userId);
        document.getElementById('user-id-display').textContent = `معرف المستخدم الخاص بك: ${userId}`;
        document.getElementById('user-id-display').style.display = 'block';
        await loadUserList();
      } else {
        // User is signed out.
        console.log("User signed out. Signing in anonymously...");
        try {
          if (initialAuthToken) {
            await firebase.auth().signInWithCustomToken(auth, initialAuthToken);
          } else {
            await firebase.auth().signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Authentication failed:", error);
          showModal(`خطأ في المصادقة: ${error.message}`);
        }
      }
    });

  } catch (error) {
    console.error("Firebase initialization error:", error);
    showModal(`خطأ في تهيئة Firebase: ${error.message}`);
  }
}

/**
 * Displays a modal with a given message.
 * @param {string} message The message to display.
 */
function showModal(message) {
  $modalMessage.textContent = message;
  $messageModal.style.display = 'flex';
}

// Event listener for closing the modal
$modalCloseButton.addEventListener('click', () => {
  $messageModal.style.display = 'none';
});

// Event listener for copying the user ID
$copyUserIdButton.addEventListener('click', () => {
  if (userId) {
    // Use the old document.execCommand for better compatibility in iframes
    const textarea = document.createElement('textarea');
    textarea.value = userId;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      showModal('تم نسخ معرف المستخدم!');
    } catch (err) {
      console.error('Failed to copy text:', err);
      showModal('فشل في نسخ معرف المستخدم.');
    }
    document.body.removeChild(textarea);
  } else {
    showModal('لم يتم العثور على معرف المستخدم.');
  }
});

// Set up event listeners after the DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Check if Firebase is available
  if (typeof firebase === 'undefined') {
    console.error("Firebase is not loaded. Please check the script tag.");
    showModal("خطأ: لم يتم تحميل Firebase. الرجاء التحقق من اتصالك بالإنترنت.");
    return;
  }
  initializeFirebase();

  // Handle opening a chat
  if ($openChatButtons) {
    $openChatButtons.forEach(button => {
      button.addEventListener('click', () => {
        const chatType = button.getAttribute('data-chat-type');
        let chatName = 'Public Chat';
        let chatId = 'public';

        if (chatType === 'private') {
          chatName = 'Private Chat';
          chatId = userId;
        }

        switchChat(chatId, chatName);
      });
    });
  }

  // Handle starting a private chat with a specific user ID
  if ($startChatBtn) {
    $startChatBtn.addEventListener('click', async () => {
      const targetUserId = $chatWithUserIdInput.value.trim();
      if (targetUserId) {
        if (targetUserId === userId) {
          showModal('لا يمكنك الدردشة مع نفسك!');
          return;
        }
        const chatId = [userId, targetUserId].sort().join('_');
        switchChat(chatId, `الدردشة مع ${targetUserId}`);
        $chatWithUserIdInput.value = '';
      } else {
        showModal('الرجاء إدخال معرف مستخدم لبدء الدردشة.');
      }
    });
  }

  // Handle sending a message
  if ($sendButton) {
    $sendButton.addEventListener('click', sendMessage);
  }
  if ($messageInput) {
    $messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  }

  // Handle the back button
  if ($backButton) {
    $backButton.addEventListener('click', () => {
      switchChat('public', 'الدردشة العامة');
      $chatContainer.style.display = 'none';
      $chatButtonsContainer.style.display = 'flex';
      $userList.style.display = 'block';
    });
  }
});

/**
 * Switches the current chat and loads its history.
 * @param {string} chatId The ID of the chat to switch to.
 * @param {string} chatName The display name of the chat.
 */
function switchChat(chatId, chatName) {
  if (!db) {
    showModal('Firebase Firestore غير مهيأ.');
    return;
  }
  
  if (currentChatId) {
    // Unsubscribe from the previous chat's messages
    if (unsubscribeMessages) {
      unsubscribeMessages();
    }
  }

  currentChatId = chatId;
  currentChatName = chatName;

  document.getElementById('chat-title').textContent = currentChatName;
  $chatHistory.innerHTML = '';
  $chatButtonsContainer.style.display = 'none';
  $userList.style.display = 'none';
  $chatContainer.style.display = 'flex';

  // Load new chat history
  loadChatHistory(chatId);
}

/**
 * Loads the list of active users from Firestore.
 */
async function loadUserList() {
  if (!db) {
    console.error('Firestore not initialized.');
    return;
  }
  const usersRef = db.collection(`artifacts/${appId}/users`);
  const usersContainer = document.getElementById('users-container');
  usersContainer.innerHTML = ''; // Clear previous list

  // Use a query to get all documents under the "users" collection for the current app.
  const usersQuery = usersRef;

  // Listen for real-time updates using onSnapshot
  db.collection(`artifacts/${appId}/users`).onSnapshot(snapshot => {
    const users = [];
    snapshot.forEach(doc => {
      // Get the user ID from the document ID
      const userDocId = doc.id;
      users.push(userDocId);
    });

    // Display the updated list of users
    usersContainer.innerHTML = '';
    users.forEach(uid => {
      const userItem = document.createElement('div');
      userItem.className = 'p-2 rounded-lg bg-gray-700 hover:bg-gray-600 cursor-pointer transition-colors';
      userItem.textContent = `المستخدم: ${uid}`;
      userItem.addEventListener('click', () => {
        // Start a private chat with this user
        const privateChatId = [userId, uid].sort().join('_');
        switchChat(privateChatId, `الدردشة مع ${uid}`);
      });
      usersContainer.appendChild(userItem);
    });
  }, err => {
    console.error('Error getting users:', err);
    showModal('خطأ في تحميل قائمة المستخدمين.');
  });
}

/**
 * Loads the chat history for a given chat ID.
 * @param {string} chatId The ID of the chat.
 * @returns {function} The unsubscribe function for the listener.
 */
let unsubscribeMessages = () => {};

function loadChatHistory(chatId) {
  if (!db) {
    showModal('Firebase Firestore غير مهيأ.');
    return;
  }
  
  const messagesRef = db.collection(`artifacts/${appId}/public/data/chats/${chatId}/messages`);
  const messagesQuery = messagesRef.orderBy('timestamp', 'asc');

  unsubscribeMessages = messagesQuery.onSnapshot(snapshot => {
    $chatHistory.innerHTML = '';
    const messages = [];
    snapshot.forEach(doc => {
      messages.push(doc.data());
    });

    messages.forEach(msg => {
      displayMessage(msg);
    });

    // Scroll to the bottom of the chat history
    $chatHistory.scrollTop = $chatHistory.scrollHeight;
  }, err => {
    console.error('Error getting chat history:', err);
    showModal('خطأ في تحميل سجل الدردشة.');
  });

  return unsubscribeMessages;
}

/**
 * Sends a message to the current chat.
 */
async function sendMessage() {
  if (!db || !currentChatId) {
    showModal('الرجاء اختيار دردشة أولاً.');
    return;
  }

  const messageText = $messageInput.value.trim();
  if (messageText === '') {
    return;
  }

  const messagesRef = db.collection(`artifacts/${appId}/public/data/chats/${currentChatId}/messages`);

  const message = {
    senderId: userId,
    senderName: userId, // Using the full user ID as a name for simplicity
    text: messageText,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
  };

  try {
    await messagesRef.add(message);
    $messageInput.value = '';
    // Scroll to the bottom after sending
    $chatHistory.scrollTop = $chatHistory.scrollHeight;
  } catch (error) {
    console.error("Error sending message:", error);
    showModal(`خطأ في إرسال الرسالة: ${error.message}`);
  }
}

/**
 * Displays a single message in the chat history.
 * @param {object} message The message object.
 */
function displayMessage(message) {
  const messageElement = document.createElement('div');
  const isMyMessage = message.senderId === userId;
  messageElement.className = `flex flex-col mb-2 p-3 rounded-xl max-w-[70%] transition-transform duration-300 transform ${isMyMessage ? 'bg-blue-600 text-white self-end translate-x-1' : 'bg-gray-700 text-gray-100 self-start -translate-x-1'}`;

  const senderNameElement = document.createElement('div');
  senderNameElement.className = `text-xs font-semibold mb-1 ${isMyMessage ? 'text-right' : 'text-left'}`;
  senderNameElement.textContent = isMyMessage ? 'أنت' : message.senderName;
  messageElement.appendChild(senderNameElement);

  const textElement = document.createElement('div');
  textElement.className = 'text-sm break-words';
  textElement.textContent = message.text;
  messageElement.appendChild(textElement);

  if (message.timestamp) {
    const timestampElement = document.createElement('div');
    timestampElement.className = `text-[10px] opacity-70 mt-1 ${isMyMessage ? 'text-right' : 'text-left'}`;
    const date = message.timestamp.toDate();
    timestampElement.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    messageElement.appendChild(timestampElement);
  }

  $chatHistory.appendChild(messageElement);
}

// -------------------------------------------------------------
// HTML and CSS structure
// -------------------------------------------------------------
```html
<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الدردشة</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <link href="[https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap)" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .message-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2d3748;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        /* Hide scrollbar for webkit browsers */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge, and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        /* New styles for a more responsive layout */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-area {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        .chat-sidebar {
            display: flex;
            flex-direction: column;
            width: 30%;
            min-width: 250px;
            max-width: 350px;
            padding-right: 1rem;
        }
        .chat-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 0.75rem;
            background-color: #2d3748;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

<div class="container bg-gray-800 rounded-2xl shadow-lg p-6 flex flex-col h-[90vh] md:h-[85vh] fade-in">
    <!-- Header -->
    <div class="text-center pb-4 border-b border-gray-700 mb-4">
        <h1 class="text-3xl font-bold">تطبيق الدردشة</h1>
        <p class="text-sm text-gray-400 mt-2" id="user-id-display" style="display:none;"></p>
        <button id="copy-user-id" class="mt-2 px-3 py-1 bg-gray-700 text-sm rounded-full hover:bg-gray-600 transition-colors">نسخ معرف المستخدم</button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="chat-area flex-grow overflow-hidden">
            <!-- Chat Buttons and User List (Sidebar) -->
            <div id="chat-buttons-container" class="chat-sidebar space-y-4">
                <div class="bg-gray-700 p-4 rounded-xl shadow-inner">
                    <h2 class="text-xl font-semibold mb-2">الدردشات المتاحة</h2>
                    <div class="flex flex-col space-y-2">
                        <button class="open-chat-btn px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors" data-chat-type="public">الدردشة العامة</button>
                    </div>
                </div>
                <div class="bg-gray-700 p-4 rounded-xl shadow-inner flex-grow overflow-y-auto no-scrollbar">
                    <h2 class="text-xl font-semibold mb-2">المستخدمون النشطون</h2>
                    <div id="users-container" class="flex flex-col space-y-2">
                        <p class="text-sm text-gray-400">جارٍ تحميل قائمة المستخدمين...</p>
                    </div>
                </div>
            </div>

            <!-- Chat Window (Main) -->
            <div id="chat-container" class="chat-main hidden">
                <!-- Chat Header -->
                <div class="flex items-center p-4 border-b border-gray-600">
                    <button id="back-button" class="text-gray-400 hover:text-gray-100 transition-colors mr-3">
                        <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                    </button>
                    <h2 id="chat-title" class="text-xl font-semibold"></h2>
                </div>
                <!-- Chat History -->
                <div id="chat-history" class="flex-grow p-4 overflow-y-auto no-scrollbar flex flex-col">
                    <p class="text-gray-400 text-center my-auto">ابدأ الدردشة!</p>
                </div>
                <!-- Message Input -->
                <div class="flex p-4 border-t border-gray-600">
                    <input type="text" id="message-input" placeholder="اكتب رسالة..." class="flex-grow px-4 py-2 rounded-full bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-600 transition-all">
                    <button id="send-button" class="ml-2 px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors">إرسال</button>
                </div>
            </div>
        </div>
        
        <!-- Private Chat Input -->
        <div class="mt-4 p-4 bg-gray-700 rounded-xl shadow-inner flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-2">
            <input type="text" id="chat-with-user-id" placeholder="أدخل معرف المستخدم للدردشة الخاصة" class="w-full px-4 py-2 rounded-full bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-600 transition-all">
            <button id="start-chat-btn" class="w-full md:w-auto px-6 py-2 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition-colors">ابدأ الدردشة</button>
        </div>
    </div>

</div>

<!-- Modal for messages -->
<div id="message-modal" class="message-modal">
    <div class="modal-content">
        <p id="modal-message" class="text-gray-100 mb-4"></p>
        <button id="modal-close-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">إغلاق</button>
    </div>
</div>

<script src="[https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js](https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js)"></script>
<script src="[https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js](https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js)"></script>
<script src="[https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js](https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js)"></script>
</body>
</html>
